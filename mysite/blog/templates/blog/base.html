{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Il Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBqar">
    <link rel="stylesheet" href="{% static 'css/blog.css' %}">
    <link rel="stylesheet" href="https://fontawesome.webstorage-4sigma.it/fontawesome-pro-6.2.1-web/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fontawesome.webstorage-4sigma.it/fontawesome-pro-6.2.1-web/css/all.min.css"></noscript>
    <body>
        <div class="container">
          <div class="contacts">
            <h2>contatti</h2>
            <div class="search-bar">
              <input type="text" id="search-input" placeholder="Cerca contatti..." oninput="filterContacts()">
            </div>
            <ul id="userList"></ul>
          </div>
          <div class="chat">
              {% block content %}
              {% endblock %}
              </div>
          </div>
  </body>
  <script>
    
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('search-input').focus();
    });
    
    function filterContacts() {
      var input = document.getElementById('search-input').value.toLowerCase();
      var contactList = document.getElementById('userList');
      var contacts = contactList.getElementsByTagName('li');
      for (var i = 0; i < contacts.length; i++) {
        var name = contacts[i].innerText.toLowerCase();
        if (name.includes(input)) {
          contacts[i].style.display = 'flex';
        } else {
          contacts[i].style.display = 'none';
        }
      }
    }
    
    function cambia_contatto(nome) {
      window.location.pathname = '/chat/' + nome + '/';
      const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = "javascript:cambia_contatto('" + user.first_name + "')";
        link.textContent = user.first_name;
        listItem.appendChild(link);
        userList.appendChild(listItem);
    }
    
    fetch("{% url 'blog:api get users' %}", {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRFToken': "{{ csrf_token }}",
      },
      body: JSON.stringify({        
      })
    })
    .then(resp => resp.json())
    .then(responseData => {
      const userList = document.getElementById('userList');
      responseData.users.forEach(user => {
        const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = "javascript:cambia_contatto('" + user.first_name + "')";
        link.textContent = user.first_name;
        listItem.appendChild(link);
        userList.appendChild(listItem);

      });
    });  
    {% if nome %}
    const roomName = '{{nome|slugify}}';
    //JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket('ws://'
    + window.location.host
    + '/ws/chat/'
    + roomName
    + '/');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').value += (data.message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };

    const messageBox = document.querySelector('#messageBox');
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const message = data.message;
    const messageElement = document.createElement('div');
    messageElement.innerText = message;
    messageBox.appendChild(messageElement);  };
    {% endif %}
  </script>   
</html>